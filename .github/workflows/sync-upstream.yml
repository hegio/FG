name: Sync Upstream Playlist

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout your repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Download upstream content
      run: |
        echo "Downloading from upstream..."
        # å°è¯•å¤šä¸ªé•œåƒæºä¸‹è½½åŸæ–‡ä»¶
        if curl -L --fail --max-time 30 -o "æ¸¯å°å¤§é™†.tmp" "https://ghfast.top/https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/æ¸¯å°å¤§é™†"; then
          echo "Downloaded via ghfast.top"
        elif curl -L --fail --max-time 30 -o "æ¸¯å°å¤§é™†.tmp" "https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/æ¸¯å°å¤§é™†"; then
          echo "Downloaded via GitHub raw"
        else
          echo "::error::Failed to download upstream file"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [ ! -s "æ¸¯å°å¤§é™†.tmp" ]; then
          echo "::error::Downloaded file is empty"
          exit 1
        fi
        
        mv "æ¸¯å°å¤§é™†.tmp" "æ¸¯å°å¤§é™†"
        echo "Downloaded $(wc -l < æ¸¯å°å¤§é™†) lines"

    - name: Convert to standard M3U format
      run: |
        # åˆ›å»º Python è„šæœ¬æ¥å¤„ç†æ ¼å¼è½¬æ¢ï¼ˆæ¯” shell æ›´å¯é ï¼‰
        cat > convert.py << 'EOF'
        import re
        
        input_file = 'æ¸¯å°å¤§é™†'
        output_file = 'playlist.m3u'
        
        try:
            with open(input_file, 'r', encoding='utf-8') as f:
                lines = f.readlines()
        except UnicodeDecodeError:
            # å¦‚æœ UTF-8 å¤±è´¥ï¼Œå°è¯•å…¶ä»–ç¼–ç 
            with open(input_file, 'r', encoding='gbk') as f:
                lines = f.readlines()
        
        output = ['#EXTM3U x-tvg-url=""']
        current_group = 'æœªåˆ†ç±»'
        count = 0
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # æ£€æµ‹åˆ†ç»„æ ‡è®° (,#genre#)
            if ',#genre#' in line:
                current_group = line.replace(',#genre#', '').strip()
                continue
            
            # è·³è¿‡ YouTube é“¾æ¥ï¼ˆIPTV è½¯ä»¶ä¸æ”¯æŒï¼‰
            if 'youtube.com' in line or 'youtu.be' in line:
                continue
            
            # å¤„ç† "åç§°,URL" æ ¼å¼
            # æ³¨æ„ï¼šURL ä¸­å¯èƒ½åŒ…å«é€—å·ï¼Œæ‰€ä»¥è¦æ‰¾åˆ°ç¬¬ä¸€ä¸ª http ä½ç½®
            if ',http' in line or ',p2p://' in line or ',rtmp://' in line or ',rtsp://' in line:
                # æ‰¾åˆ°åè®®å¼€å§‹çš„ä½ç½®
                for protocol in ['http://', 'https://', 'p2p://', 'rtmp://', 'rtsp://']:
                    if protocol in line:
                        idx = line.find(',' + protocol)
                        if idx != -1:
                            name = line[:idx].strip()
                            url = line[idx+1:].strip()
                            
                            # æ¸…ç†åç§°ä¸­çš„å¤šä½™ç©ºæ ¼
                            name = re.sub(r'\s+', ' ', name)
                            
                            # å†™å…¥æ ‡å‡† M3U æ ¼å¼
                            output.append(f'#EXTINF:-1 group-title="{current_group}",{name}')
                            output.append(url)
                            count += 1
                            break
        
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write('\n'.join(output))
        
        print(f"Converted {count} channels to M3U format")
        print(f"First 20 lines of output:")
        for line in output[:20]:
            print(line)
        EOF
        
        # è¿è¡Œè½¬æ¢è„šæœ¬
        python3 convert.py
        
        # åŒæ—¶åˆ›å»ºä¸€ä¸ªå¤‡ä»½çš„ æ¸¯å°å¤§é™†.m3uï¼ˆå†…å®¹ç›¸åŒï¼‰
        cp playlist.m3u æ¸¯å°å¤§é™†.m3u

    - name: Commit and push if changed
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "No changes detected, skipping commit"
        else
          git commit -m "ğŸ”„ Auto-sync: Update playlist from FGBLH/FG [$(date '+%Y-%m-%d %H:%M')]"
          git push
          echo "Successfully pushed updates"
        fi
