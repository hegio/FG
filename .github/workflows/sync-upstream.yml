name: Sync Upstream Playlist

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨Actionsé¡µé¢ç‚¹å‡»è¿è¡Œï¼‰
  push:
    branches: [main]  # é¦–æ¬¡æ¨é€æ—¶è§¦å‘ä¸€æ¬¡

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout your repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Download upstream content
      run: |
        # å°è¯•å¤šä¸ªé•œåƒæºä¸‹è½½åŸæ–‡ä»¶ï¼ˆå®¹é”™å¤„ç†ï¼‰
        echo "Downloading from upstream..."
        
        # å°è¯• ghfast.top ä»£ç†
        if curl -L --fail --max-time 30 -o "æ¸¯å°å¤§é™†.tmp" "https://ghfast.top/https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/æ¸¯å°å¤§é™†"; then
          echo "Downloaded via ghfast.top"
        # å¤±è´¥åˆ™å°è¯• GitHub ç›´è¿
        elif curl -L --fail --max-time 30 -o "æ¸¯å°å¤§é™†.tmp" "https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/æ¸¯å°å¤§é™†"; then
          echo "Downloaded via GitHub raw"
        else
          echo "::error::Failed to download upstream file"
          exit 1
        fi
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
        if [ ! -s "æ¸¯å°å¤§é™†.tmp" ]; then
          echo "::error::Downloaded file is empty"
          exit 1
        fi
        
        # è½¬æ¢ä¸º UTF-8 ç¼–ç ï¼ˆå¤„ç†ä¸­æ–‡ä¹±ç ï¼‰
        file -i "æ¸¯å°å¤§é™†.tmp"
        mv "æ¸¯å°å¤§é™†.tmp" "æ¸¯å°å¤§é™†"

    - name: Generate M3U files
      run: |
        # æ£€æŸ¥åŸæ–‡ä»¶æ˜¯å¦å·²æœ‰ M3U å¤´éƒ¨
        if ! head -1 "æ¸¯å°å¤§é™†" | grep -q "^#EXTM3U"; then
          echo "Adding M3U header..."
          echo "#EXTM3U x-tvg-url=\"\"" > playlist.m3u
          cat "æ¸¯å°å¤§é™†" >> playlist.m3u
          echo "#EXTM3U x-tvg-url=\"\"" > æ¸¯å°å¤§é™†.m3u
          cat "æ¸¯å°å¤§é™†" >> æ¸¯å°å¤§é™†.m3u
        else
          # å·²æœ‰å¤´éƒ¨ï¼Œç›´æ¥å¤åˆ¶
          cp "æ¸¯å°å¤§é™†" playlist.m3u
          cp "æ¸¯å°å¤§é™†" æ¸¯å°å¤§é™†.m3u
        fi
        
        echo "Generated files:"
        ls -la *.m3u
        echo "First 10 lines of playlist.m3u:"
        head -10 playlist.m3u

    - name: Commit and push if changed
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "No changes detected, skipping commit"
        else
          git commit -m "ğŸ”„ Auto-sync: Update playlist from FGBLH/FG [$(date '+%Y-%m-%d %H:%M')]"
          git push
          echo "Successfully pushed updates"
        fi
