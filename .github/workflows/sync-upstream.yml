name: Sync Upstream Playlists

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶åŒæ­¥
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Download upstream files
      run: |
        # å®šä¹‰ä¸‰ä¸ªéœ€è¦åŒæ­¥çš„æ–‡ä»¶
        files=(
          "æ¸¯å°å¤§é™†:https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/æ¸¯å°å¤§é™†"
          "å®‰åš:https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/å®‰åš"
          "æµ·é©¬å½±è§†:https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/æµ·é©¬å½±è§†"
        )
        
        for item in "${files[@]}"; do
          name="${item%%:*}"
          url="${item##*:}"
          
          echo "Downloading $name from $url"
          
          # å°è¯•ä¸‹è½½
          if curl -L --fail --max-time 30 -o "$name.tmp" "https://ghfast.top/$url"; then
            echo "âœ“ Downloaded $name via ghfast.top"
          elif curl -L --fail --max-time 30 -o "$name.tmp" "$url"; then
            echo "âœ“ Downloaded $name via direct"
          else
            echo "::warning::Failed to download $name"
            continue
          fi
          
          if [ -s "$name.tmp" ]; then
            mv "$name.tmp" "$name"
            echo "âœ“ Saved $name ($(wc -l < $name) lines)"
          else
            echo "::warning::Downloaded $name is empty"
            rm -f "$name.tmp"
          fi
        done

    - name: Convert playlist files to M3U
      run: |
        cat > convert.py << 'EOF'
        import os
        import re

        def convert_to_m3u(input_file, output_file):
            """å°†ç®€æ˜“æ ¼å¼è½¬æ¢ä¸ºæ ‡å‡†M3Uæ ¼å¼"""
            if not os.path.exists(input_file):
                print(f"âš ï¸  {input_file} not found, skipping")
                return False
            
            try:
                with open(input_file, 'r', encoding='utf-8') as f:
                    lines = f.readlines()
            except UnicodeDecodeError:
                with open(input_file, 'r', encoding='gbk') as f:
                    lines = f.readlines()
            
            output = ['#EXTM3U x-tvg-url=""']
            current_group = 'æœªåˆ†ç±»'
            count = 0
            
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                
                # æ£€æµ‹åˆ†ç»„æ ‡è®° (,#genre#)
                if ',#genre#' in line:
                    current_group = line.replace(',#genre#', '').strip()
                    continue
                
                # è·³è¿‡ YouTube é“¾æ¥
                if 'youtube.com' in line or 'youtu.be' in line:
                    continue
                
                # å¤„ç† "åç§°,URL" æ ¼å¼
                for protocol in [',http://', ',https://', ',p2p://', ',rtmp://', ',rtsp://']:
                    if protocol in line:
                        idx = line.find(protocol)
                        name = line[:idx].strip()
                        url = line[idx+1:].strip()
                        name = re.sub(r'\s+', ' ', name)
                        
                        output.append(f'#EXTINF:-1 group-title="{current_group}",{name}')
                        output.append(url)
                        count += 1
                        break
            
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write('\n'.join(output))
            
            print(f"âœ“ Converted {input_file} -> {output_file} ({count} channels)")
            return True

        # åªè½¬æ¢ç›´æ’­æºæ–‡ä»¶ï¼ˆæ¸¯å°å¤§é™†ã€å®‰åšï¼‰
        # æ³¨æ„ï¼šæµ·é©¬å½±è§†æ˜¯TVBoxé…ç½®æ–‡ä»¶ï¼Œä¿æŒåŸæ ·ï¼Œä¸è½¬æ¢
        convert_to_m3u("æ¸¯å°å¤§é™†", "playlist.m3u")
        convert_to_m3u("å®‰åš", "anbo.m3u")
        EOF
        
        python3 convert.py

    - name: Commit and push changes
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”„ Auto-sync: Update all files [$(date '+%Y-%m-%d %H:%M')]"
          git push
          echo "âœ… Synced successfully"
        fi
