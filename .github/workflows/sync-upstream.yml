name: Sync Upstream Playlists

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Download upstream files
      run: |
        # å®šä¹‰è¦åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåç§°, ä¸Šæ¸¸è·¯å¾„ï¼‰
        files=(
          "æ¸¯å°å¤§é™†:https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/æ¸¯å°å¤§é™†"
          "å®‰åš:https://raw.githubusercontent.com/FGBLH/FG/refs/heads/main/å®‰åš"
        )
        
        for item in "${files[@]}"; do
          name="${item%%:*}"
          url="${item##*:}"
          
          echo "Downloading $name from $url"
          
          # å°è¯•å¤šä¸ªé•œåƒæº
          if curl -L --fail --max-time 30 -o "$name.tmp" "https://ghfast.top/$url"; then
            echo "âœ“ Downloaded $name via ghfast.top"
          elif curl -L --fail --max-time 30 -o "$name.tmp" "$url"; then
            echo "âœ“ Downloaded $name via direct"
          else
            echo "::warning::Failed to download $name, keeping old version if exists"
            continue
          fi
          
          if [ -s "$name.tmp" ]; then
            mv "$name.tmp" "$name"
            echo "âœ“ Saved $name ($(wc -l < $name) lines)"
          else
            echo "::warning::Downloaded $name is empty"
            rm -f "$name.tmp"
          fi
        done

    - name: Convert to M3U format
      run: |
        cat > convert.py << 'EOF'
        import os
        import re
        
        def convert_file(input_file, output_file):
            """å°†ç®€æ˜“æ ¼å¼è½¬æ¢ä¸ºæ ‡å‡†M3Uæ ¼å¼"""
            if not os.path.exists(input_file):
                print(f"âš ï¸  {input_file} not found, skipping")
                return False
            
            try:
                with open(input_file, 'r', encoding='utf-8') as f:
                    lines = f.readlines()
            except UnicodeDecodeError:
                with open(input_file, 'r', encoding='gbk') as f:
                    lines = f.readlines()
            
            output = ['#EXTM3U x-tvg-url=""']
            current_group = 'æœªåˆ†ç±»'
            count = 0
            
            for line in lines:
                line = line.strip()
                if not line:
                    continue
                
                # æ£€æµ‹åˆ†ç»„æ ‡è®° (,#genre#)
                if ',#genre#' in line:
                    current_group = line.replace(',#genre#', '').strip()
                    continue
                
                # è·³è¿‡ YouTube é“¾æ¥
                if 'youtube.com' in line or 'youtu.be' in line:
                    continue
                
                # å¤„ç† "åç§°,URL" æ ¼å¼ï¼ˆæ”¯æŒ http/https/p2p/rtmp/rtspï¼‰
                for protocol in [',http://', ',https://', ',p2p://', ',rtmp://', ',rtsp://']:
                    if protocol in line:
                        idx = line.find(protocol)
                        name = line[:idx].strip()
                        url = line[idx+1:].strip()
                        
                        # æ¸…ç†åç§°
                        name = re.sub(r'\s+', ' ', name)
                        
                        output.append(f'#EXTINF:-1 group-title="{current_group}",{name}')
                        output.append(url)
                        count += 1
                        break
            
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write('\n'.join(output))
            
            print(f"âœ“ Converted {input_file} -> {output_file} ({count} channels)")
            return True
        
        # è½¬æ¢ä¸¤ä¸ªæ–‡ä»¶
        # æ–¹æ¡ˆAï¼šåˆ†åˆ«ç”Ÿæˆç‹¬ç«‹çš„m3uæ–‡ä»¶ï¼ˆæ¨èï¼Œä¾¿äºç®¡ç†ï¼‰
        convert_file("æ¸¯å°å¤§é™†", "playlist.m3u")
        convert_file("å®‰åš", "anbo.m3u")  # å®‰åšä¸“ç”¨æ–‡ä»¶
        
        # æ–¹æ¡ˆBï¼šåˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼ˆå¦‚éœ€åˆå¹¶ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šï¼‰
        # convert_file("æ¸¯å°å¤§é™†", "temp1.m3u")
        # convert_file("å®‰åš", "temp2.m3u")
        # os.system("cat temp1.m3u temp2.m3u | grep -v '^#EXTM3U' > combined.m3u")
        # os.system("echo '#EXTM3U x-tvg-url=\\\"\\\"' | cat - combined.m3u > playlist.m3u && rm combined.m3u temp1.m3u temp2.m3u")
        
        print("Conversion completed")
        EOF
        
        python3 convert.py

    - name: Commit and push
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ğŸ”„ Auto-sync: Update playlists [$(date '+%Y-%m-%d %H:%M')]"
          git push
          echo "âœ… Successfully synced both files"
        fi
